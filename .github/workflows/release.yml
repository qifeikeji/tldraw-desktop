name: Release (Linux AppImage)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Git tag to build & publish (e.g. v1.2.3). Tag must already exist.'
        required: true
        type: string
      dry_run:
        description: 'Dry run (build without publishing)'
        required: false
        default: false
        type: boolean
      draft:
        description: 'Create/Update release as draft'
        required: false
        default: false
        type: boolean
      prerelease:
        description: 'Mark release as prerelease'
        required: false
        default: false
        type: boolean

# Cancel in-progress runs for the same workflow
concurrency:
  group: release-${{ inputs.tag }}
  cancel-in-progress: true

jobs:
  build-and-publish-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write

    steps:
      - name: Checkout repository (tag)
        uses: actions/checkout@v4
        with:
          ref: refs/tags/${{ inputs.tag }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build app (typecheck + electron-vite build)
        run: npm run build

      - name: Build Linux AppImage (x64 only)
        run: npx electron-builder --linux AppImage --x64 --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check output
        run: |
          ls -la dist || true
          ls -la dist/*.AppImage

      - name: Upload build artifact (AppImage)
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage-x64
          path: dist/*.AppImage
          if-no-files-found: error
          retention-days: 7

      - name: Create/Update GitHub Release and upload AppImage
        if: ${{ !inputs.dry_run }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag }}
          name: ${{ inputs.tag }}
          draft: ${{ inputs.draft }}
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          files: |
            dist/*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
