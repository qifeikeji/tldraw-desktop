name: Release (Linux AppImage)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Optional. Git tag to build & publish to GitHub Release (e.g. v1.2.3 or 1.2.3). If omitted, builds from ref and uploads an artifact only.'
        required: false
        default: ''
        type: string
      ref:
        description: 'Git ref (branch, tag, or SHA) to build from when tag is omitted. Also used as initial checkout for tag resolution.'
        required: false
        default: 'main'
        type: string
      dry_run:
        description: 'Dry run (build without publishing)'
        required: false
        default: false
        type: boolean
      draft:
        description: 'Create/Update release as draft'
        required: false
        default: false
        type: boolean
      prerelease:
        description: 'Mark release as prerelease'
        required: false
        default: false
        type: boolean

# Cancel in-progress runs for the same workflow
concurrency:
  group: release-${{ inputs.tag || inputs.ref }}
  cancel-in-progress: true

jobs:
  build-and-publish-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Resolve tag (optional)
        id: resolve_tag
        shell: bash
        run: |
          TAG_INPUT="${{ inputs.tag }}"
          if [ -z "$TAG_INPUT" ]; then
            echo "tag=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Ensure we have tags locally
          git fetch --tags --force

          TAG="$TAG_INPUT"
          if git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
            echo "tag=$TAG" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "$TAG" != v* ]] && git rev-parse -q --verify "refs/tags/v$TAG" >/dev/null; then
            echo "tag=v$TAG" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "::error::Tag not found: '$TAG_INPUT' (also tried 'v$TAG_INPUT'). Please create & push the tag first, or leave 'tag' empty to build from ref."
          echo "Recent tags:"
          git tag --list --sort=-creatordate | head -50
          exit 1

      - name: Checkout tag
        if: ${{ steps.resolve_tag.outputs.tag != '' }}
        run: git checkout --force refs/tags/${{ steps.resolve_tag.outputs.tag }}

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2

      - name: Install dependencies
        run: npm ci

      - name: Build app (typecheck + electron-vite build)
        run: npm run build

      - name: Build Linux AppImage (x64 only)
        run: npx electron-builder --linux AppImage --x64 --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify AppImage output
        run: ls -la dist/*.AppImage

      - name: Upload build artifact (AppImage)
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage-x64
          path: dist/*.AppImage
          if-no-files-found: error
          retention-days: 7

      - name: Create/Update GitHub Release and upload AppImage
        if: ${{ !inputs.dry_run && steps.resolve_tag.outputs.tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.resolve_tag.outputs.tag }}
          name: ${{ steps.resolve_tag.outputs.tag }}
          draft: ${{ inputs.draft }}
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          files: |
            dist/*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
